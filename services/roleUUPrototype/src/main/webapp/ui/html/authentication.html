<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="stylesheet/less" type="text/css" href="/s/css/role.less">
<script src="/s/script/vendor/less.js" type="text/javascript"></script>
<script src="/d/openapp"></script>
<script src="/s/script/vendor/jquery.js"></script>
<script src="/s/script/vendor/jquery.tmpl.js"></script>
<script src="/s/script/vendor/jquery.url.norequirejs.js" type="text/javascript"></script>
</head>
<body>
	<script id="signInTemplate" type="text/x-jquery-tmpl">
		<h1>Sign in</h1>
		<p>You are signing in at <strong>${contextUri}</strong>.</p>
		{{each($i, $realm) data[uri]["http://purl.org/openapp/realm"]}}<div class="realm">
			<p style="clear: both; color: #666"></p>
			<div class="authenticationBoxes">
				{{each($i, $auth) $data.data[$realm.value]["http://purl.org/openapp/authentication"]}}<div class="authenticationBox">
					{{tmpl($data.data[$auth.value], {realm: $realm.value}) "#authenticationTemplate_" +
				  	$data.data[$auth.value]["http://www.w3.org/1999/02/22-rdf-syntax-ns#type"][0].value.match(/\w+$/)[0]}}
				</div>{{/each}}
			</div>
			<p style="clear: both; color: #666; padding: 1em">Realm: ${$realm.value}. A cookie will be stored on your computer.</p>
		{{/each}}</div>
    </script>
	<script id="signOutTemplate" type="text/x-jquery-tmpl">
		<h1>Sign out</h1>
		<p class="message">Signing out from <strong>${contextUri}</strong>&hellip;</p>
    </script>
	<script id="authenticationTemplate_Secret" type="text/x-jquery-tmpl">
		<form class="signInForm" method="post" action="/o/session/login">
			<h2>Sign in using password</h2>
			<p class="message"></p>
			<p>Email<br/><input class="usernameInput text" name="username" type="text"/></p>
			<p>Password<br/><input class="passwordInput text" name="password" type="password"/></p>
			<input class="realmInput" name="realm" type="hidden" value="${$item.realm}"/>
			<input class="contextInput" name="context" type="hidden" value="${contextUri}"/>
			<input class="returnInput" name="return" type="hidden" value="${returnUri}"/>
			<p><input class="signinInput" name="signin" type="submit" value="Sign in" class="submit"/></p>
		</form>
    </script>
	<script id="authenticationTemplate_OpenID" type="text/x-jquery-tmpl">
		<h2>Sign in using&hellip;</h2>
		
		<p class="messageOAuth2"></p>
    	<a href="/o/oauth2/request?discovery=https://accounts.google.com/.well-known/openid-configuration&client_id=263505441471-qh264egece36h6aclabdf27cic8cl505.apps.googleusercontent.com&client_secret=wZfRO-eURr_hmeKL1F1nZFm1&return=${returnUriEnc}"><h3>
		<img src="/s/images/googleicon.png" width="15px" height="15px">Google</h3></a> 
		
		<div id="selectdiv">
		<select id="oidcselect">
			<option> Loading provider ... </option>
		</select>
		<button id="gobutton"> Go </button>
		</div>
		<div>
		<br>
    		<a href="#" id="formToggle"><b>Add your own provider</b> <img id="addarrow" src="/s/images/rightarrow.svg" height="12px"></a>
    		  <form id="oidcForm" style="display:none">
    			<br>
    			<div>
	    			<input type="text" id="oidcConfig" name="config" placeholder="Configuration URL" />
	    			<input type="text" id="oidcName" name="name" placeholder="Name" />
	    		</div>
	    		<br>
    			<input type="checkbox" id="oidcDynamic" name="dynreg"> Try to dynamically register client (only check if you're sure there is no ROLE-SDK client registered on your provider yet)
    			<br>
    			<br>
    			<div>
	    			<input type="text" id="clientId" name="clientid" placeholder="Client ID" />
	    			<input type="text" id="clientSecret" name="clientsecret" placeholder="Client Secret" />
    			</div>
    			<br>
    			<input type="button" id="oidcSubmit" value="Submit" />
    		</form>
    	</div>
    </script>

	<div id="pageContent">
	</div>
	
	<script>
		var contextUri, contextUriEnc;
		var returnUri = decodeURIComponent($.url().param("return") || "");
		var returnUriEnc = encodeURIComponent(returnUri);
		var action = $.url().param("action") || "signin";
		openapp.resource.get(document.location.href, function(context) {
			contextUri = context.uri;
			contextUriEnc = encodeURIComponent(context.uri);
			if (action === "signin") {
				$("#signInTemplate").tmpl(context).appendTo($("#pageContent"));
				$(".signInForm").submit(function(){
					var signInForm = this;
					if ($(this).find(".usernameInput").val().length == 0) {
						$(this).find(".message").html("Enter your email address.");
						$(signInForm).find(".usernameInput").select();
						return false;
					}
					if ($(this).find(".passwordInput").val().length == 0) {
						$(this).find(".message").html("Enter your password.");
						$(signInForm).find(".passwordInput").select();
						return false;
					}
					$(this).find(".message").html("Signing in&hellip;");
					$(this).find("input").attr("disabled", "disabled");
					$.ajax( "/o/session/login", {
						type: "POST",
						data: JSON.stringify({
							username: $(this).find(".usernameInput").val(),
							password: $(this).find(".passwordInput").val(),
							realm: $(this).find(".realmInput").val(),
							context: $(this).find(".contextInput").val(),
							"return": $(this).find(".returnInput").val()
						}),
						headers: { Accept: "application/json" },
						dataType: "json", success: function(data) {
							$(signInForm).find(".message").text("Signed in.");
							if (returnUri != "") {
								window.location = returnUri;
							}
						}, error: function(data) {
							$(signInForm).find(".message").text("The user name or password you entered is incorrect.");
							$(signInForm).find(".passwordInput").val("");
							$(signInForm).find("input").attr("disabled", null);
							$(signInForm).find(".usernameInput").select();
						}});
					return false;
				});
				$(".authenticationBox").mouseover(function(){
					$(this).stop(true).animate({ backgroundColor: "#aaffaa", queue: false }, "fast");
				});
				$(".authenticationBox").mouseout(function(){
					$(this).stop(true).animate({ backgroundColor: "#fff", queue: false }, "fast");
				});
			} else if (action === "signout") {
				$("#signOutTemplate").tmpl(context).appendTo($("#pageContent"));
				$.ajax( "/o/session/logout", {
					type: "POST",
					data: JSON.stringify({
						context: contextUri,
						"return": returnUri
					}),
					headers: { Accept: "application/json" },
					dataType: "json", success: function(data) {
						$("#pageContent").find(".message").html("You have been signed out from <strong class='contextUri'/>.");
						$("#pageContent").find(".contextUri").text(contextUri);
						if (returnUri != "") {
							window.setTimeout(function(){
								window.location = returnUri;
							}, 1000);
						}
					}, error: function(data) {
						$("#pageContent").find(".message").text(data.statusText);
					}});
			}
			document.title = $("h1").text();
		}, {});
			
	</script>
	<script>	
		function getProviders(){
			$.ajax({
				method:"GET",
				url:"/o/oauth2/provider/",
				statusCode: {
					404: function(){
							$("#oidcselect").html("<option> Failed to load Provider data </option>");
						},
					200: function(data){
							var string="";
							$.each(data,function(i){
								string += '<option value="'+data[i].config+'">'+data[i].title+'</option>'
							});
							$("#oidcselect").html(string);
						}
					}
				});
			}
		(function($){
			$.fn.serializeObject = function()
			{
			    var o = {};
			    var a = this.serializeArray();
			    $.each(a, function() {
			        if (o[this.name] !== undefined) {
			            if (!o[this.name].push) {
			                o[this.name] = [o[this.name]];
			            }
			            o[this.name].push(this.value || '');
			        } else {
			            o[this.name] = this.value || '';
			        }
			    });
			    return o;
			};
		})(jQuery);
		
		function postProvider(){
			var postData = $("#oidcForm").serializeObject();
			$.ajax({
				type:"POST",
				url:"/o/oauth2/provider/",
				statusCode: {
					409: function(data){
							$("#oidcinfo").html("The provider already exists as "+data.name+".");
						},
					200: function(data){
							$("#oidcinfo").html("Provider added successfully");
							getProviders();
						}
				},
				dataType:"json",
				data: JSON.stringify(postData)
			});
		}
		$(document).ready(function(){
				$("body").on("click","#formToggle",function(){
					if( $("#oidcForm").css("display") == "none"){
						$("#addarrow").attr("src","/s/images/downarrow.svg");
						$("#oidcForm").css("display","block");
					}else{
						$("#addarrow").attr("src","/s/images/rightarrow.svg");
						$("#oidcForm").css("display","none");
					}
				});
				$("body").on("click","#oidcSubmit",function(){
					postProvider();
				});
				
				$("body").on("click","#oidcDynamic",function(){
					var cb = $("#oidcDynamic").is(":checked");
					$("#clientId,#clientSecret").prop("disabled", cb);
				});
				
				$("body").on("click","#gobutton",function(){
					window.location.assign("/o/oauth2/request?discovery="+document.getElementById("oidcselect").value);	
				});
				
			});
		$(window).load(function(){
					var myvar;
					
					myvar = setTimeout(getProviders(), 3000);
				});
		
	</script>
</body>
</html>
